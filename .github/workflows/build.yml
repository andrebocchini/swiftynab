name: Build and Test

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "master" ]

env:
  SWIFT_VERSION: "6.2"
  XCODE_VERSION: "26.2"

jobs:
  build:
    name: Build and Test Swift Package
    strategy:
      matrix:
        os: [macos-15, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Select Xcode version
        if: runner.os == 'macOS'
        run: sudo xcode-select -s "/Applications/Xcode_${{ env.XCODE_VERSION }}.app"

      - name: Install Swift via swiftly
        if: runner.os == 'Linux'
        run: |
          curl -O "https://download.swift.org/swiftly/linux/swiftly-1.1.1-$(uname -m).tar.gz"
          tar -zxf "swiftly-1.1.1-$(uname -m).tar.gz"
          ./swiftly init --assume-yes
          . "$HOME/.local/share/swiftly/env.sh"
          swiftly install "$SWIFT_VERSION"
          echo "$HOME/.local/share/swiftly/toolchains/$SWIFT_VERSION/usr/bin" >> $GITHUB_PATH

      - name: Build
        run: swift build

      - name: Test
        run: swift test --enable-code-coverage

      - name: Find llvm-cov path
        run: |
          if [[ "$(uname)" == "Darwin" ]]; then
            LLVM_COV_PATH="$(xcrun --find llvm-cov)"
          else
            LLVM_COV_PATH="$(dirname "$(realpath "$(which swift)")")/llvm-cov"
          fi
          echo "LLVM_COV_PATH=$LLVM_COV_PATH" >> $GITHUB_ENV

      - name: Generate coverage report
        run: |
          "$LLVM_COV_PATH" export \
            .build/debug/SwiftYNABPackageTests.xctest/Contents/MacOS/SwiftYNABPackageTests \
            -instr-profile .build/debug/codecov/default.profdata \
            -format="lcov" > coverage.lcov || \
          "$LLVM_COV_PATH" export \
            .build/debug/SwiftYNABTests \
            -instr-profile .build/debug/codecov/default.profdata \
            -format="lcov" > coverage.lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.lcov
